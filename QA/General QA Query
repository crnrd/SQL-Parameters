WbVarDef nibbler_code_version = '$[?challanger_version]'; 
WbVarDef champ_code_version = '$[?champion_version]';


--@WbResult Nibbler Champ vs Champion difference - count 1
Select decision_challenger, decision_champion, reason_challenger, reason_champion, count(*) from
(
SELECT Challenger.payment_id, 
				Challenger.decision decision_challenger,
				Champion.decision decision_champion, 
				Challenger.reason reason_challenger, 
				Champion.reason reason_champion
FROM(
      SELECT distinct on (payment_id) payment_id, variables #>> '{Analytic, decision}' decision,
 			             variables #>> '{Analytic, reason}' reason
                  FROM decisions
                  WHERE application_name = 'Nibbler_Challenger'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')                  
			)Challenger
      left JOIN (SELECT DISTINCT on (payment_id) payment_id,
 			             variables #>> '{Analytic, decision}' decision,
 			             ltrim (variables #>> '{Analytic, reason}') reason
                   FROM decisions
                         WHERE application_name = 'Bender_Auto_Decide'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')                                                                  
                  ) Champion
                         
               ON (Challenger.payment_id = Champion.payment_id))x
where reason_challenger != reason_champion

group by 1,2,3,4
order by 1,2,3,4
;

--@WbResult Nibbler Champ/Challenge difference in decision full results
select * from (
SELECT Challenger.payment_id, 
				Challenger.decision decision_challenger,
				Champion.decision decision_champion, 
				Challenger.reason reason_challenger, 
				Champion.reason reason_champion
FROM(
      SELECT distinct on (payment_id) payment_id, variables #>> '{Analytic, decision}' decision,
 			             variables #>> '{Analytic, reason}' reason
                  FROM decisions
                  WHERE application_name = 'Nibbler_Challenger'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')              
			)Challenger
      left JOIN (SELECT DISTINCT on (payment_id) payment_id,
 			             variables #>> '{Analytic, decision}' decision,
 			             ltrim (variables #>> '{Analytic, reason}') reason
                   FROM decisions
                         WHERE application_name = 'Bender_Auto_Decide'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')                                      
) Champion
                         
               ON (Challenger.payment_id = Champion.payment_id))x
where reason_challenger != reason_champion
order by reason_challenger
;

--@WbResult Nibbler Champ/challenge diff in variables full results

SELECT *
FROM (
SELECT Challenger.payment_id,
             Challenger.key,
             Challenger_value,
             Champion_value
      FROM (SELECT DISTINCT payment_id,
                   KEY,
                   value AS Challenger_value
            FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                  FROM decisions
                  WHERE application_name = 'Nibbler_Challenger'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')                
						) d) Challenger
        LEFT JOIN (SELECT DISTINCT payment_id,
                          KEY,
                          value AS Champion_Value
                   FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                         FROM decisions
                  WHERE application_name = 'Bender_Auto_Decide'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')               
							 ) z) Champion
               ON (Challenger.payment_id = Champion.payment_id
									AND Challenger.key = Champion.key)
WHERE (lower (challenger_value) !=lower (champion_value))
) s
order by key;

--@WbResult Nibbler Champ/challenge diff in variables - count

SELECT key, Challenger_value, Champion_value, count(*)
FROM (
SELECT Challenger.payment_id,
             Challenger.key,
             Challenger_value,
             Champion_value
      FROM (SELECT DISTINCT payment_id,
                   KEY,
                   value AS Challenger_value
            FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                  FROM decisions
                  WHERE application_name = 'Nibbler_Challenger'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')                    
						) d) Challenger
        LEFT JOIN (SELECT DISTINCT payment_id,
                          KEY,
                          value AS Champion_Value
                   FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                         FROM decisions
                  WHERE application_name = 'Bender_Auto_Decide'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')              
							 ) z) Champion
               ON (Challenger.payment_id = Champion.payment_id
									AND Challenger.key = Champion.key)
WHERE (lower (challenger_value) !=lower (champion_value))
) s
group by 1, 2, 3
order by 1, 2, 3;

