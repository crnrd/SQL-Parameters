--select * from vm_decisions_two_days where payment_id is not null order by payment_id desc limit 10;

--refresh MATERIALIZED VIEW vm_decisions_two_days;
--Bender_Pending_Payment_Manual Nibbler_Challenger_pending_payment_manual_pending_payment_manual_pending_payment_manual
WbVarDef nibbler_code_version = '$[?challanger_version]'; 
WbVarDef champ_code_version = '$[?champion_version]';


--@WbResult Nibbler Champ vs Champion difference - count 1
Select decision_challenger, decision_champion, reason_challenger, reason_champion, count(*) from
(
SELECT Challenger.payment_id, 
				Challenger.decision decision_challenger,
				Champion.decision decision_champion, 
				Challenger.reason reason_challenger, 
				Champion.reason reason_champion
FROM(
      SELECT distinct on (payment_id) payment_id, variables #>> '{Analytic, decision}' decision,
 			             variables #>> '{Analytic, reason}' reason
                  FROM vm_decisions_two_days
                  WHERE application_name = 'Nibbler_Challenger_pending_payment_manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')                  
			)Challenger
      left JOIN (SELECT DISTINCT on (payment_id) payment_id,
 			             variables #>> '{Analytic, decision}' decision,
 			             ltrim (variables #>> '{Analytic, reason}') reason
                   FROM vm_decisions_two_days
                         WHERE application_name = 'Bender_Pending_Payment_Manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')                                                                  
                  ) Champion
                         
               ON (Challenger.payment_id = Champion.payment_id))x
where reason_challenger != reason_champion 
and (reason_challenger not in ('approve_payment_model_score_low_threshold_under_limit good approve score','random_approve_num_all_under_limit_low_threshold good approve score') 
and reason_champion not in ('approve_payment_model_score_low_threshold_under_limit good approve score','random_approve_num_all_under_limit_low_threshold good approve score'))

group by 1,2,3,4
order by 1,2,3,4
;

--@WbResult Nibbler Champ/Challenge difference in decision full results
select * from (
SELECT Challenger.payment_id, 
				Challenger.decision decision_challenger,
				Champion.decision decision_champion, 
				Challenger.reason reason_challenger, 
				Champion.reason reason_champion
FROM(
      SELECT distinct on (payment_id) payment_id, variables #>> '{Analytic, decision}' decision,
 			             variables #>> '{Analytic, reason}' reason
                  FROM vm_decisions_two_days
                  WHERE application_name = 'Nibbler_Challenger_pending_payment_manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')              
			)Challenger
      left JOIN (SELECT DISTINCT on (payment_id) payment_id,
 			             variables #>> '{Analytic, decision}' decision,
 			             ltrim (variables #>> '{Analytic, reason}') reason
                   FROM vm_decisions_two_days
                         WHERE application_name = 'Bender_Pending_Payment_Manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')                                      
) Champion
                         
               ON (Challenger.payment_id = Champion.payment_id))x
where reason_challenger != reason_champion
and (reason_challenger not in ('approve_payment_model_score_low_threshold_under_limit good approve score','random_approve_num_all_under_limit_low_threshold good approve score') 
and reason_champion not in ('approve_payment_model_score_low_threshold_under_limit good approve score','random_approve_num_all_under_limit_low_threshold good approve score'))
order by reason_challenger
;

--variables count
SELECT key, Challenger_value, Champion_value, count(*)
FROM (
SELECT Challenger.payment_id,
             Challenger.key,
             Challenger_value,
             Champion_value
      FROM (SELECT DISTINCT payment_id,
                   KEY,
                   value AS Challenger_value
            FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                  FROM vm_decisions_two_days
                  WHERE application_name = 'Nibbler_Challenger_pending_payment_manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')                    
						) d) Challenger
        LEFT JOIN (SELECT DISTINCT payment_id,
                          KEY,
                          value AS Champion_Value
                   FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                         FROM vm_decisions_two_days
                  WHERE application_name = 'Bender_Pending_Payment_Manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')              
							 ) z) Champion
               ON (Challenger.payment_id = Champion.payment_id
									AND Challenger.key = Champion.key)
WHERE (lower (challenger_value) !=lower (champion_value)) and
Challenger.key not in ('variable_for_random_approve', 
'variable_for_random_approve_num_all_high_threshold',
'variable_for_approve_payment_model_score_low_threshold',
'random_value_for_control_group',
'card_verification_degree', 'num_all', 'payment_model_score','variable_for_random_approve_num_all_low_threshold')
)s
group by 1, 2, 3
order by 1, 2, 3;

--@WbResult Nibbler Champ/challenge diff in variables full results
SELECT *
FROM (
SELECT Challenger.payment_id,
             Challenger.key,
             Challenger_value,
             Champion_value
      FROM (SELECT DISTINCT payment_id,
                   KEY,
                   value AS Challenger_value
            FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                  FROM vm_decisions_two_days
                  WHERE application_name = 'Nibbler_Challenger_pending_payment_manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[challanger_version]')                
						) d) Challenger
        LEFT JOIN (SELECT DISTINCT payment_id,
                          KEY,
                          value AS Champion_Value
                   FROM (SELECT payment_id,
                         (jsonb_each_text(variables#> '{Analytic,variables, Analytic}')). *
                         FROM vm_decisions_two_days
                  WHERE application_name = 'Bender_Pending_Payment_Manual'
                  and variables #>> '{Analytic, analytic_code_version}' in ('$[champion_version]')               
							 ) z) Champion
               ON (Challenger.payment_id = Champion.payment_id
									AND Challenger.key = Champion.key)
WHERE (lower (challenger_value) !=lower (champion_value)) 
and Challenger.key not in ('variable_for_random_approve', 
'variable_for_random_approve_num_all_high_threshold',
'variable_for_approve_payment_model_score_low_threshold',
'random_value_for_control_group',
'card_verification_degree', 'num_all','payment_model_score','variable_for_random_approve_num_all_low_threshold')


) s
order by key;




